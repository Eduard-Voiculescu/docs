---
title: Создание подграфов на Cosmos
---

This guide is an introduction on building subgraphs indexing [Cosmos](https://cosmos.network/) based blockchains.

## Что такое Cosmos подграфы?

The Graph позволяет разработчикам обрабатывать события блокчейна и делать полученные данные легко доступными через открытый API GraphQL, известный как подграф. [Graph Node](https://github.com/graphprotocol/graph-node) теперь может обрабатывать события Cosmos, а это означает, что разработчики Cosmos теперь могут создавать подграфы для удобного индексирования событий в сети.

Существует четыре типа обработчиков, поддерживаемых в подграфах Cosmos:

- **Обработчики блоков** запускаются всякий раз, когда к цепочке добавляется новый блок.
- **Обработчики событий** запускаются при возникновении определенного события.
- **Обработчики транзакций** запускаются, когда происходит транзакция.
- ** Обработчики сообщений** запускаются при появлении определенного сообщения.

На основе [официальной документации Cosmos](https://docs.cosmos.network/):

> [Events](https://docs.cosmos.network/main/learn/advanced/events) are objects that contain information about the execution of the application. They are mainly used by service providers like block explorers and wallets to track the execution of various messages and index transactions.

> [Transactions](https://docs.cosmos.network/main/learn/advanced/transactions) are objects created by end-users to trigger state changes in the application.

> [Messages](https://docs.cosmos.network/main/learn/advanced/transactions#messages) are module-specific objects that trigger state transitions within the scope of the module they belong to.

Хотя доступ ко всем данным можно получить с помощью обработчика блоков, другие обработчики позволяют разработчикам субграфов обрабатывать данные гораздо более детально.

## Создание субграфа на Cosmos

### Зависимости подграфа

[graph-cli](https://github.com/graphprotocol/graph-tooling/tree/main/packages/cli) is a CLI tool to build and deploy subgraphs, version `>=0.30.0` is required in order to work with Cosmos subgraphs.

[graph-ts](https://github.com/graphprotocol/graph-tooling/tree/main/packages/ts) is a library of subgraph-specific types, version `>=0.27.0` is required in order to work with Cosmos subgraphs.

### Основные компоненты подграфа

Когда дело доходит до определения субграфа, имеется три ключевых момента:

**subgraph.yaml**: файл YAML, содержащий манифест подграфа, который определяет, какие события отслеживать и как их обрабатывать.

**schema.graphql**: схема GraphQL, которая определяет, какие данные хранятся для Вашего субграфа и как их запрашивать через GraphQL.

**AssemblyScript Mappings**: код [AssemblyScript](https://github.com/AssemblyScript/assemblyscript), преобразующий данные блокчейна в определенные объекты в Вашей схеме.

### Определение манифеста подграфа

Манифест подграфа (`subgraph.yaml`) определяет источники данных для подграфа, релевантные триггеры и функции (`handlers`), которые должны выполняться в ответ на эти триггеры. Ниже приведен пример манифеста подграфа для подграфа на Cosmos:

```yaml
specVersion: 0.0.5
description: Cosmos Subgraph Example
schema:
  file: ./schema.graphql # ссылка на файл схемы
dataSources:
  - kind: cosmos
    name: CosmosHub
    network: cosmoshub-4 # это будет меняться для каждого блокчейна, основанного на Cosmos. В данном случае в примере используется основная сеть Cosmos Hub.
    source:
      startBlock: 0 # требуется для Cosmos, установите для этого параметра значение 0, чтобы начать индексирование с начального блока генезиса чейна.
    mapping:
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      blockHandlers:
        - handler: handleNewBlock # имя функции в мэппинг-файле
      eventHandlers:
        - event: rewards # тип события, которое будет обрабатываться
          handler: handleReward # имя функции в мэппинг-файле
      transactionHandlers:
        - handler: handleTransaction # имя функции в мэппинг-файле
      messageHandlers:
        - message: /cosmos.staking.v1beta1.MsgDelegate # тип сообщения
          handler: handleMsgDelegate # имя функции в мэппинг-файле
      file: ./src/mapping.ts # ссылка на мэппинг-файл скрипта сборки
```

- Подграфы на Cosmos представляют новый `вид` источника данных (`cosmos`).
- `Сеть` должна соответствовать чейну в экосистеме Cosmos. В примере используется майннет Cosmos Hub.

### Определение схемы

Schema definition describes the structure of the resulting subgraph database and the relationships between entities. This is agnostic of the original data source. There are more details on subgraph schema definition [here](/developing/creating-a-subgraph/#the-graphql-schema).

### Сопоставления AssemblyScript

Обработчики событий написаны на языке [AssemblyScript](https://www.assemblyscript.org/).

Индексация Cosmos вводит специфичные для Cosmos типы данных в [AssemblyScript API](/developing/assemblyscript-api/).

```tsx
class Block {
  header: Header
  evidence: EvidenceList
  resultBeginBlock: ResponseBeginBlock
  resultEndBlock: ResponseEndBlock
  transactions: Array<TxResult>
  validatorUpdates: Array<Validator>
}

class EventData {
  event: Event
  block: HeaderOnlyBlock
  tx: TransactionContext
}

class TransactionData {
  tx: TxResult
  block: HeaderOnlyBlock
}

class MessageData {
  message: Any
  block: HeaderOnlyBlock
  tx: TransactionContext
}

class TransactionContext {
  hash: Bytes
  index: u32
  code: u32
  gasWanted: i64
  gasUsed: i64
}

class HeaderOnlyBlock {
  header: Header
}

class Header {
  version: Consensus
  chainId: string
  height: u64
  time: Timestamp
  lastBlockId: BlockID
  lastCommitHash: Bytes
  dataHash: Bytes
  validatorsHash: Bytes
  nextValidatorsHash: Bytes
  consensusHash: Bytes
  appHash: Bytes
  lastResultsHash: Bytes
  evidenceHash: Bytes
  proposerAddress: Bytes
  hash: Bytes
}

class TxResult {
  height: u64
  index: u32
  tx: Tx
  result: ResponseDeliverTx
  hash: Bytes
}

class Event {
  eventType: string
  attributes: Array<EventAttribute>
}

class Any {
  typeUrl: string
  value: Bytes
}
```

Каждый тип обработчика имеет свою собственную структуру данных, которая передается в качестве аргумента функции сопоставления.

- Обработчики блоков получают тип `Block`.
- Обработчики событий получают тип `EventData`.
- Обработчики транзакций получают тип `TransactionData`.
- Обработчики сообщений получают тип `MessageData`.

Как часть `MessageData` обработчик сообщения получает контекст транзакции, который содержит наиболее важную информацию о транзакции, включающей сообщение. Контекст транзакции также доступен в типе `EventData`, но только, когда соответствующее событие связано с транзакцией. Кроме того, все обработчики получают ссылку на блок (`HeaderOnlyBlock`).

Полный список типов для интеграции Cosmos можно найти [здесь](https://github.com/graphprotocol/graph-ts/blob/4c064a8118dff43b110de22c7756e5d47fcbc8df/chain/cosmos.ts).

### Расшифровка сообщений

It's important to note that Cosmos messages are chain-specific and they are passed to a subgraph in the form of a serialized [Protocol Buffers](https://protobuf.dev/) payload. As a result, the message data needs to be decoded in a mapping function before it can be processed.

Пример того, как расшифровываются данные сообщения в подграфе, можно найти [здесь](https://github.com/graphprotocol/graph-tooling/blob/main/examples/cosmos-validator-delegations/src/decoding.ts).

## Создание и построение подграфа на Cosmos

Первым шагом перед началом написания мэппингов подграфов является создание привязок типов на основе объектов, определенных в файле схемы подграфа (`schema.graphql`). Это позволит функциям мэппинга создавать новые объекты этих типов и сохранять их в хранилище. Для этого используется команда CLI `codegen`:

```bash
$ graph codegen
```

После того как мэппинги готовы, необходимо построить подграф. На этом шаге будут выделены все ошибки, которые могут быть в манифесте или мэппингах. Подграф должен быть успешно построен, чтобы его можно было развернуть на Graph Node. Это можно сделать с помощью команды `build` командной строки:

```bash
$ graph build
```

## Развертывание подграфа на Cosmos

Как только ваш подграф создан, вы можете развернуть его с помощью команды `graph deploy` CLI:

**Subgraph Studio**

Visit the Subgraph Studio to create a new subgraph.

```bash
graph deploy --studio subgraph-name
```

**Local Graph Node (based on default configuration):**

```bash
graph create subgraph-name --node http://localhost:8020
```

```bash
graph deploy subgraph-name --node http://localhost:8020/ --ipfs http://localhost:5001
```

## Запрос подграфа на Cosmos

The GraphQL endpoint for Cosmos subgraphs is determined by the schema definition, with the existing API interface. Please visit the [GraphQL API documentation](/querying/graphql-api/) for more information.

## Поддерживаемые блокчейны Cosmos

### Cosmos Hub

#### Что такое Cosmos Hub?

The [Cosmos Hub blockchain](https://hub.cosmos.network/) is the first blockchain in the [Cosmos](https://cosmos.network/) ecosystem. You can visit the [official documentation](https://docs.cosmos.network/) for more information.

#### Сети

Cosmos Hub mainnet is `cosmoshub-4`. Cosmos Hub current testnet is `theta-testnet-001`. <br/>Other Cosmos Hub networks, i.e. `cosmoshub-3`, are halted, therefore no data is provided for them.

### Osmosis

> Osmosis support in Graph Node and on Subgraph Studio is in beta: please contact the graph team with any questions about building Osmosis subgraphs!

#### Что такое Osmosis?

[Osmosis](https://osmosis.zone/) is a decentralized, cross-chain automated market maker (AMM) protocol built on top of the Cosmos SDK. It allows users to create custom liquidity pools and trade IBC-enabled tokens. You can visit the [official documentation](https://docs.osmosis.zone/) for more information.

#### Сети

Osmosis mainnet is `osmosis-1`. Osmosis current testnet is `osmo-test-4`.

## Примеры подграфов

Here are some example subgraphs for reference:

[Block Filtering Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-block-filtering)

[Validator Rewards Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-validator-rewards)

[Validator Delegations Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-validator-delegations)

[Osmosis Token Swaps Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-osmosis-token-swaps)
